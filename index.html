<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="SHORTCUT ICON" href="icon.png" />
    <title>String Master</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Consolas', 'Menlo', 'Roboto Mono', 'Noto Sans TC', '微軟正黑體', 'Arial', sans-serif;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100%;
            width: 100%;
        }

        .left,
        .right {
            flex: 0 0 calc(50% - 30px);
            padding: 6px;
            box-sizing: border-box;
            height: 100%;
            overflow: auto;
        }

        .middle {
            flex: 0 0 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        textarea {
            width: 100%;
            height: calc(100% - 6px);
            resize: none;
            padding: 10px;
            box-sizing: border-box;
        }

        #output {
            white-space: pre;
            background-color: #f4f4f4;
            padding: 10px;
            height: calc(100% - 6px);
            overflow: auto;
            box-sizing: border-box;
        }

        #copyButton {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #copyButton:hover {
            background-color: #45a049;
        }

        .string {
            color: #008000;
        }

        .number {
            color: #0000ff;
        }

        .boolean {
            color: #b22222;
        }

        .null {
            color: #808080;
        }

        .key {
            color: #a52a2a;
        }

        .tag {
            color: #800080;
        }

        .attr {
            color: #ff0000;
        }

        #notify {
            position: absolute;
            top: 10px;
            left: calc(50% - 30px);
            color: #fff;
            background-color: #333;
            padding: 6px 12px;
            border-radius: 4px;
            opacity: 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="notify"></div>
        <div class="left">
            <textarea id="input" placeholder="Paste JSON or XML String"></textarea>
        </div>
        <div class="middle">
            <button id="copyButton">Copy</button>
        </div>
        <div class="right">
            <div id="output"></div>
        </div>
    </div>

    <script>
        const input = document.getElementById('input');
        const output = document.getElementById('output');
        const copyButton = document.getElementById('copyButton');

        window.addEventListener('load', loadAndFormat);
        input.addEventListener('input', formatAndSave);
        copyButton.addEventListener('click', copyOutput);

        function formatAndSave() {
            const text = input.value.trim();
            localStorage.setItem('lastInput', text);
            formatInput(text);
        }

        function loadAndFormat() {
            const savedText = localStorage.getItem('lastInput');
            if (savedText) {
                input.value = savedText;
                formatInput(savedText);
            }
        }

        function formatInput() {
            const text = input.value.trim();
            if (text === '') {
                output.innerHTML = '';
                return;
            }

            try {
                if (text.startsWith('<')) {
                    // XML
                    const formatted = formatXML(text);
                    output.innerHTML = syntaxHighlightXML(formatted);
                } else {
                    // JSON
                    const obj = JSON.parse(text);
                    const formatted = JSON.stringify(obj, null, 4);
                    output.innerHTML = syntaxHighlightJSON(formatted);
                }
            } catch (e) {
                output.textContent = text;
            }
        }

        function formatXML(xml) {
            let formatted = '';
            let indent = '';
            const tab = '    ';
            xml.split(/>\s*</).forEach(function (node) {
                if (node.match(/^\/\w/)) {
                    indent = indent.substring(tab.length);
                }
                formatted += indent + '<' + node + '>\r\n';
                if (node.match(/^<?\w[^>]*[^\/]$/) && !node.startsWith("?") && !node.startsWith("/")) {
                    indent += tab;
                }
            });
            return formatted.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').trim();
        }

        function syntaxHighlightJSON(json) {
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        function syntaxHighlightXML(xml) {
            return xml
                .replace(/(&lt;)([^&!\s>]+)([^>]*?)(&gt;)/g, function (match, p1, p2, p3, p4) {
                    let attributes = p3.replace(/(\w+)\s*=\s*(".*?")/g, '<span class="attr">$1</span>=<span class="string">$2</span>');
                    return p1 + '<span class="tag">' + p2 + '</span>' + attributes + p4;
                })
                .replace(/(&lt;\/?)([^&>]+)(&gt;)/g, '$1<span class="tag">$2</span>$3');
        }

        function copyOutput() {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = output.textContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            notify("Copied!")
        }

        function notify(msg) {
            const notifyElement = document.getElementById('notify');
            notifyElement.style.display = 'none';
            notifyElement.innerHTML = msg;
            fadeIn(notifyElement, 600);

            setTimeout(() => {
                fadeOut(notifyElement, 600);
            }, 3000);
        }

        function fadeIn(element, duration, opacity = 0.7) {
            element.style.opacity = 0;
            element.style.display = 'block';

            let start = null;

            function animateFadeIn(timestamp) {
                if (!start) start = timestamp;
                let progress = timestamp - start;
                element.style.opacity = Math.min(progress / duration, opacity);
                if (progress < duration) {
                    requestAnimationFrame(animateFadeIn);
                }
            }

            requestAnimationFrame(animateFadeIn);
        }

        function fadeOut(element, duration, opacity = 0.7) {
            element.style.opacity = opacity;

            let start = null;

            function animateFadeOut(timestamp) {
                if (!start) start = timestamp;
                let progress = timestamp - start;
                element.style.opacity = 1 - Math.min(progress / duration, 1);
                if (progress < duration) {
                    requestAnimationFrame(animateFadeOut);
                } else {
                    element.style.display = 'none';
                }
            }

            requestAnimationFrame(animateFadeOut);
        }

    </script>
</body>

</html>