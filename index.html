<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="SHORTCUT ICON" href="icon.png" />
    <title>String Master</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Consolas', 'Menlo', 'Roboto Mono', 'Noto Sans TC', 'å¾®è»Ÿæ­£é»‘é«”', 'Arial', sans-serif;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: row;
            height: 100%;
            width: 100%;
        }

        .left,
        .right {
            padding: 6px;
            box-sizing: border-box;
            height: 100%;
            overflow: auto;
        }

        .left {
            flex: 0 0 45%;
        }

        .right {
            flex: 0 0 55%;
            position: relative;
        }

        textarea {
            width: 100%;
            height: calc(100% - 6px);
            resize: none;
            padding: 10px;
            box-sizing: border-box;
        }

        #output {
            white-space: pre;
            background-color: #f4f4f4;
            padding: 10px;
            height: calc(100% - 6px);
            overflow: auto;
            box-sizing: border-box;
            border: 1px solid #666;
            border-radius: 4px;
        }

        #copyButton {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        #copyButton:hover {
            opacity: 1;
        }

        .string {
            color: #008000;
        }

        .number {
            color: #0000ff;
        }

        .boolean {
            color: #b22222;
        }

        .null {
            color: #808080;
        }

        .key {
            color: #a52a2a;
        }

        .tag {
            color: #800080;
        }

        .attr {
            color: #ff0000;
        }

        #notify {
            position: absolute;
            top: 10px;
            left: calc(50% - 30px);
            color: #fff;
            background-color: #333;
            padding: 6px 12px;
            border-radius: 4px;
            opacity: 0;
        }

        @media (max-width: 769px) {
            .container {
                flex-direction: column;
            }

            .left,
            .right {
                flex: 1;
                height: 50%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="notify"></div>
        <div class="left">
            <textarea id="input" placeholder="Paste JSON or XML String"></textarea>
        </div>
        <div class="right">
            <div id="output"></div>
            <button id="copyButton" title="Copy">ðŸ“‹</button>
        </div>
    </div>

    <script>
        const input = document.getElementById('input');
        const output = document.getElementById('output');
        const copyButton = document.getElementById('copyButton');

        copyButton.addEventListener('click', copyOutput);
        input.addEventListener('input', formatAndSave);
        window.addEventListener('load', loadAndFormat);

        function formatAndSave() {
            const text = input.value.trim();
            localStorage.setItem('lastInput', text);
            formatInput(text);
        }

        function loadAndFormat() {
            const savedText = localStorage.getItem('lastInput');
            if (savedText) {
                input.value = savedText;
                formatInput(savedText);
            }
        }

        function formatInput(text) {
            if (text === '') {
                output.textContent = '';
                return;
            }
            try {
                output.innerHTML = text.startsWith('<') ? syntaxHighlightXML(formatXML(text)) : syntaxHighlightJSON(JSON.stringify(JSON.parse(text), null, 4));
            } catch (e) {
                output.textContent = 'Error formatting text\n' + text;
            }
        }

        function formatXML(xml) {
            let formatted = '';
            let indent = '';
            const tab = '    ';
            xml.split(/>\s*</).forEach(function (node) {
                if (node.match(/^\/\w/)) {
                    indent = indent.substring(tab.length);
                }
                formatted += indent + '<' + node + '>\r\n';
                if (node.match(/^<?\w[^>]*[^\/]$/) && !node.startsWith("?") && !node.startsWith("/")) {
                    indent += tab;
                }
            });
            return formatted.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').trim();
        }

        function syntaxHighlightJSON(json) {
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        function syntaxHighlightXML(xml) {
            return xml
                .replace(/(&lt;)([^&!\s>]+)([^>]*?)(&gt;)/g, function (match, p1, p2, p3, p4) {
                    let attributes = p3.replace(/(\w+)\s*=\s*(".*?")/g, '<span class="attr">$1</span>=<span class="string">$2</span>');
                    return p1 + '<span class="tag">' + p2 + '</span>' + attributes + p4;
                })
                .replace(/(&lt;\/?)([^&>]+)(&gt;)/g, '$1<span class="tag">$2</span>$3');
        }

        function copyOutput() {
            navigator.clipboard.writeText(output.textContent).then(() => {
                notify("Copied!");
                copyButton.textContent = 'âœ…';
                setTimeout(() => {
                    copyButton.textContent = 'ðŸ“‹';
                }, 3000);
            });
        }

        function notify(msg) {
            const notifyElement = document.getElementById('notify');
            notifyElement.textContent = msg;
            fadeIn(notifyElement, 600);
            setTimeout(() => fadeOut(notifyElement, 600), 3000);
        }

        function fadeIn(element, duration, opacity = 0.7) {
            element.style.opacity = 0;
            element.style.display = 'block';

            let start = null;

            function animateFadeIn(timestamp) {
                if (!start) start = timestamp;
                let progress = timestamp - start;
                element.style.opacity = Math.min(progress / duration, opacity);
                if (progress < duration) {
                    requestAnimationFrame(animateFadeIn);
                }
            }

            requestAnimationFrame(animateFadeIn);
        }

        function fadeOut(element, duration, opacity = 0.7) {
            element.style.opacity = opacity;

            let start = null;

            function animateFadeOut(timestamp) {
                if (!start) start = timestamp;
                let progress = timestamp - start;
                element.style.opacity = 1 - Math.min(progress / duration, 1);
                if (progress < duration) {
                    requestAnimationFrame(animateFadeOut);
                } else {
                    element.style.display = 'none';
                }
            }

            requestAnimationFrame(animateFadeOut);
        }
    </script>
</body>

</html>